<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siyadah WhatsApp - Live API Testing</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: ltr;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .status-badge {
            display: inline-block;
            background: #27ae60;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .api-section {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .test-panel {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .section-title {
            color: #2c3e50;
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .step-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .step-number {
            background: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: absolute;
            top: -15px;
            left: 20px;
        }

        .step-title {
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            margin-top: 10px;
        }

        .step-description {
            color: #7f8c8d;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .result-box {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            border: 2px solid #34495e;
        }

        .qr-display {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #3498db;
            margin-top: 20px;
        }

        .qr-image {
            max-width: 250px;
            border: 3px solid #2c3e50;
            border-radius: 10px;
            display: none;
        }

        .success { color: #27ae60; font-weight: bold; }
        .error { color: #e74c3c; font-weight: bold; }
        .warning { color: #f39c12; font-weight: bold; }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #ecf0f1;
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            width: 0%;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }

        .api-endpoint {
            background: #ecf0f1;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 10px 0;
            border-left: 4px solid #3498db;
        }

        .tips-box {
            background: #e8f6f3;
            border: 1px solid #1abc9c;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .tips-box h4 {
            color: #16a085;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Live API Testing Interface</h1>
            <div class="subtitle">Test your WhatsApp API power in real-time - no registration or complex setup required</div>
            <div class="status-badge">Creating demo session...</div>
        </div>

        <div class="main-content">
            <div class="api-section">
                <h3 class="section-title">üéØ Test WhatsApp API Now</h3>

                <div class="step-card">
                    <div class="step-number">1</div>
                    <div class="step-title">Direct Connection</div>
                    <div class="step-description">We will automatically create a demo session with QR code instantly</div>
                    <button class="btn" onclick="connectWhatsApp()" id="connectBtn">üì± Connect WhatsApp Instantly</button>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar"></div>
                    </div>
                </div>

                <div class="step-card">
                    <div class="step-number">2</div>
                    <div class="step-title">Scan QR Code</div>
                    <div class="step-description">Scan the QR code with WhatsApp on your phone</div>
                    <div class="qr-display" id="qrDisplay">
                        <p style="color: #7f8c8d; font-size: 1.1rem;">QR code will appear here automatically</p>
                        <img id="qrImage" class="qr-image" />
                    </div>
                </div>

                <div class="step-card">
                    <div class="step-number">3</div>
                    <div class="step-title">Send Instant Message</div>
                    <div class="step-description">Send and receive messages directly through the interface</div>
                    
                    <div class="input-group">
                        <label>Phone Number (example: 966501234567)</label>
                        <input type="text" id="phoneNumber" placeholder="966501234567" value="966501234567">
                    </div>
                    
                    <div class="input-group">
                        <label>Write your message here:</label>
                        <textarea id="messageText" rows="3" placeholder="This is a completely free demo"></textarea>
                    </div>
                    
                    <button class="btn" onclick="sendMessage()" id="sendBtn" disabled>üì§ Send Instant Message</button>
                </div>

                <div class="tips-box">
                    <h4>üí° Testing Tips:</h4>
                    <ul>
                        <li>This is a completely free demo</li>
                        <li>QR code is valid for 5 minutes</li>
                        <li>You can send instant messages once connected</li>
                        <li>All data is secure and protected</li>
                    </ul>
                </div>
            </div>

            <div class="test-panel">
                <h3 class="section-title">üìä How to Test</h3>

                <div class="step-card">
                    <div class="step-number">1</div>
                    <div class="step-title">Direct Connection</div>
                    <div class="step-description">We will automatically create a demo session with QR code instantly</div>
                </div>

                <div class="step-card">
                    <div class="step-number">2</div>
                    <div class="step-title">Scan QR Code</div>
                    <div class="step-description">Scan the QR code with WhatsApp on your phone</div>
                </div>

                <div class="step-card">
                    <div class="step-number">3</div>
                    <div class="step-title">Instant Sending</div>
                    <div class="step-description">Send and receive messages directly through the interface</div>
                </div>

                <div class="api-endpoint">
                    This is a completely free demo
                </div>

                <div class="result-box" id="logBox">
                    <div>üöÄ System ready for live testing</div>
                    <div>üì± Click "Connect WhatsApp Instantly" to start</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let sessionName = 'live-demo-' + Date.now();
        let token = '';
        let isConnected = false;

        function log(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #bdc3c7;">[${timestamp}]</span> <span class="${type}">${message}</span>`;
            logBox.appendChild(logEntry);
            logBox.scrollTop = logBox.scrollHeight;
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
        }

        async function connectWhatsApp() {
            try {
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('connectBtn').textContent = 'üîÑ Connecting...';
                
                log('üöÄ Starting WhatsApp session creation...', 'info');
                updateProgress(20);
                
                // Generate token
                const tokenResponse = await fetch(`/api/${sessionName}/THISISMYSECURETOKEN/generate-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session: sessionName })
                });
                
                const tokenData = await tokenResponse.json();
                if (tokenData.status === 'success') {
                    token = tokenData.token;
                    log('‚úÖ Access token created successfully', 'success');
                    updateProgress(40);
                } else {
                    throw new Error('Failed to create access token');
                }

                // Start session
                log('üì± Starting WhatsApp session...', 'info');
                fetch(`/api/${sessionName}/start-session`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ webhook: '', waitQrCode: true })
                }).catch(() => {}); // Expected timeout

                updateProgress(60);
                log('‚è≥ Waiting for QR code generation...', 'warning');

                // Start aggressive polling for QR code
                let attempts = 0;
                const maxAttempts = 30; // Increased attempts
                const pollInterval = setInterval(async () => {
                    attempts++;
                    try {
                        log(`üîç Searching for QR code... (attempt ${attempts}/${maxAttempts})`, 'info');
                        const success = await getQRCode();
                        if (success) {
                            updateProgress(100);
                            clearInterval(pollInterval);
                            log('üéâ QR code search completed successfully!', 'success');
                        } else if (attempts >= maxAttempts) {
                            log('‚è∞ QR code search timeout - session may need manual restart', 'error');
                            clearInterval(pollInterval);
                        } else if (attempts % 5 === 0) {
                            log(`‚è≥ Still searching... QR codes can take 30-60 seconds to generate`, 'warning');
                        }
                    } catch (error) {
                        log(`‚ùå Attempt ${attempts} failed: ${error.message}`, 'error');
                        if (attempts >= maxAttempts) {
                            clearInterval(pollInterval);
                        }
                    }
                }, 2000); // Check every 2 seconds for faster detection

            } catch (error) {
                log(`‚ùå Connection error: ${error.message}`, 'error');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('connectBtn').textContent = 'üì± Connect WhatsApp Instantly';
            }
        }

        async function getQRCode() {
            try {
                // Try JSON endpoint first
                const jsonResponse = await fetch(`/api/${sessionName}/qrcode-session`, {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });

                if (jsonResponse.ok) {
                    try {
                        const data = await jsonResponse.json();
                        console.log('QR Response:', data); // Debug log
                        log(`üìä Response status: ${data.status || 'unknown'}`, 'info');
                        
                        if (data.qrcode) {
                            displayQRCode(data.qrcode);
                            log('‚úÖ QR code obtained - scan it with your phone!', 'success');
                            startConnectionCheck();
                            return true;
                        } else if (data.message) {
                            log(`üìã ${data.message}`, 'warning');
                            // If session not started, show helpful message
                            if (data.message.includes('not started')) {
                                log('‚ÑπÔ∏è Session needs more time to initialize. Please wait...', 'info');
                            }
                        } else {
                            log('‚ùå No QR code data in response', 'error');
                        }
                    } catch (e) {
                        log(`üìã JSON parse error: ${e.message}`, 'warning');
                    }
                }

                // Try PNG endpoint if JSON fails
                const pngResponse = await fetch(`/api/${sessionName}/qrcode-session`, {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'image/png'
                    }
                });

                if (pngResponse.ok && pngResponse.headers.get('content-type')?.includes('image')) {
                    const blob = await pngResponse.blob();
                    const url = URL.createObjectURL(blob);
                    displayQRCode(url);
                    log('‚úÖ QR code ready - scan it now!', 'success');
                    startConnectionCheck();
                    return true;
                }
                
                // Check status if QR not available
                const statusResponse = await fetch(`/api/${sessionName}/status-session`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (statusResponse.ok) {
                    const statusData = await statusResponse.json();
                    
                    if (statusData.status === 'CONNECTED') {
                        log('üéâ Successfully connected!', 'success');
                        isConnected = true;
                        enableSendMessage();
                        return true;
                    }
                    
                    log(`üìä Session status: ${statusData.status}`, 'info');
                }
                
                return false;
                
            } catch (error) {
                log(`‚ùå QR code error: ${error.message}`, 'error');
                return false;
            }
        }

        function displayQRCode(qrData) {
            const qrDisplay = document.getElementById('qrDisplay');
            
            // Clear previous content
            qrDisplay.innerHTML = '';
            
            // Create new image element
            const img = document.createElement('img');
            img.style.maxWidth = '300px';
            img.style.maxHeight = '300px';
            img.style.border = '2px solid #ddd';
            img.style.borderRadius = '10px';
            img.style.display = 'block';
            img.style.margin = '0 auto';
            
            // Handle base64 data or blob URL
            if (qrData.startsWith('data:image')) {
                img.src = qrData;
            } else if (qrData.startsWith('blob:')) {
                img.src = qrData;
            } else if (qrData.startsWith('iVBOR') || qrData.includes('base64')) {
                img.src = `data:image/png;base64,${qrData.replace(/^data:image\/png;base64,/, '')}`;
            } else {
                img.src = qrData;
            }
            
            // Add error handling
            img.onerror = function() {
                log('‚ùå Failed to display QR code', 'error');
                qrDisplay.innerHTML = '<p style="color: #e74c3c; text-align: center;">QR code display error</p>';
            };
            
            img.onload = function() {
                log('‚úÖ QR code displayed successfully', 'success');
            };
            
            qrDisplay.appendChild(img);
            
            const instructions = document.createElement('p');
            instructions.style.marginTop = '15px';
            instructions.style.color = '#27ae60';
            instructions.style.fontWeight = 'bold';
            instructions.style.fontSize = '1.1rem';
            instructions.style.textAlign = 'center';
            instructions.textContent = 'üì± Scan this code with WhatsApp';
            qrDisplay.appendChild(instructions);
        }

        function startConnectionCheck() {
            // Start checking connection status
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/${sessionName}/status-session`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    
                    if (data.status === 'CONNECTED') {
                        log('üéâ Successfully connected! You can now send messages', 'success');
                        isConnected = true;
                        enableSendMessage();
                        clearInterval(interval);
                    }
                } catch (error) {
                    console.error('Status check error:', error);
                }
            }, 3000);

            // Stop checking after 5 minutes
            setTimeout(() => clearInterval(interval), 300000);
        }

        function displayQRCode(qrData) {
            const qrDisplay = document.getElementById('qrDisplay');
            
            // Clear previous content
            qrDisplay.innerHTML = '';
            
            log(`QR Data received - Length: ${qrData.length}, Type: ${typeof qrData}`, 'info');
            log(`QR Data preview: ${qrData.substring(0, 100)}...`, 'info');
            
            // Create wrapper div with enhanced styling
            const wrapper = document.createElement('div');
            wrapper.style.cssText = `
                text-align: center;
                padding: 25px;
                background: linear-gradient(145deg, #f8f9fa, #e9ecef);
                border-radius: 20px;
                border: 3px solid #28a745;
                box-shadow: 0 8px 16px rgba(0,0,0,0.1);
                margin: 10px 0;
            `;
            
            // Create image element with comprehensive error handling
            const img = document.createElement('img');
            img.style.cssText = `
                max-width: 280px;
                max-height: 280px;
                border: 4px solid #ffffff;
                border-radius: 15px;
                display: block;
                margin: 0 auto 20px auto;
                background-color: white;
                padding: 15px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            `;
            
            // Enhanced QR data format handling
            let finalSrc = '';
            
            if (qrData.startsWith('data:image/')) {
                finalSrc = qrData;
                log('Format: Complete data:image URL', 'success');
            } 
            else if (qrData.startsWith('blob:')) {
                finalSrc = qrData;
                log('Format: Blob URL', 'success');
            }
            else if (qrData.startsWith('iVBOR') || (qrData.length > 500 && /^[A-Za-z0-9+\/]+=*$/.test(qrData.substring(0, 100)))) {
                // Clean base64 and ensure proper format
                const cleanBase64 = qrData.replace(/^data:image\/[^;]+;base64,/, '').replace(/\s/g, '');
                finalSrc = `data:image/png;base64,${cleanBase64}`;
                log('Format: Base64 PNG (cleaned)', 'success');
            }
            else if (qrData.startsWith('http') || qrData.startsWith('/')) {
                finalSrc = qrData;
                log('Format: Direct URL', 'success');
            }
            else {
                // Last resort - try as base64
                const cleanData = qrData.replace(/[^A-Za-z0-9+\/=]/g, '');
                finalSrc = `data:image/png;base64,${cleanData}`;
                log('Format: Fallback base64 attempt', 'warning');
            }
            
            img.src = finalSrc;
            log(`Final image source: ${finalSrc.substring(0, 60)}...`, 'info');
            
            // Enhanced error and load handling
            img.onload = function() {
                log('QR code image loaded successfully!', 'success');
                // Add success visual feedback
                wrapper.style.borderColor = '#28a745';
                const successMsg = wrapper.querySelector('.status-msg');
                if (successMsg) {
                    successMsg.textContent = 'QR Code Ready - Scan Now!';
                    successMsg.style.backgroundColor = '#d4edda';
                    successMsg.style.color = '#155724';
                }
            };
            
            img.onerror = function() {
                log('QR code image failed to load', 'error');
                wrapper.style.borderColor = '#dc3545';
                wrapper.innerHTML = `
                    <div style="padding: 40px; color: #dc3545;">
                        <h3>QR Code Display Error</h3>
                        <p>Unable to display QR code image</p>
                        <small>Data format: ${qrData.substring(0, 50)}...</small>
                    </div>
                `;
            };
            
            wrapper.appendChild(img);
            
            // Add enhanced instructions
            const instructions = document.createElement('div');
            instructions.style.cssText = `
                color: #28a745;
                font-weight: bold;
                font-size: 1.3rem;
                margin: 15px 0;
                padding: 10px;
                background: rgba(40, 167, 69, 0.1);
                border-radius: 10px;
            `;
            instructions.innerHTML = 'üì± Scan this QR code with WhatsApp';
            wrapper.appendChild(instructions);
            
            // Add dynamic status indicator
            const status = document.createElement('div');
            status.className = 'status-msg';
            status.style.cssText = `
                margin-top: 15px;
                padding: 12px 20px;
                background-color: #fff3cd;
                color: #856404;
                border-radius: 10px;
                font-size: 1rem;
                font-weight: 500;
                border: 2px solid #ffeaa7;
            `;
            status.textContent = 'Loading QR Code...';
            wrapper.appendChild(status);
            
            qrDisplay.appendChild(wrapper);
            
            log('QR code display container created and added to page', 'info');
        }

        function checkConnectionStatus() {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/${sessionName}/status-session`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    
                    if (data.status === 'CONNECTED') {
                        log('üéâ Successfully connected! You can now send messages', 'success');
                        isConnected = true;
                        enableSendMessage();
                        clearInterval(interval);
                    }
                } catch (error) {
                    // Continue checking
                }
            }, 3000);

            // Stop checking after 5 minutes
            setTimeout(() => clearInterval(interval), 300000);
        }

        function enableSendMessage() {
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('messageText').value = 'Hello! This is a demo message from WhatsApp API platform üöÄ';
        }

        async function sendMessage() {
            if (!isConnected) {
                log('‚ùå Must connect first', 'error');
                return;
            }

            const phone = document.getElementById('phoneNumber').value.trim();
            const message = document.getElementById('messageText').value.trim();

            if (!phone || !message) {
                log('‚ùå Please fill phone number and message', 'error');
                return;
            }

            try {
                document.getElementById('sendBtn').disabled = true;
                document.getElementById('sendBtn').textContent = 'üì§ Sending...';
                
                log(`üì§ Sending message to ${phone}...`, 'info');

                const response = await fetch(`/api/${sessionName}/send-message`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone: phone,
                        message: message
                    })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    log('‚úÖ Message sent successfully!', 'success');
                } else {
                    log('‚ùå Failed to send message', 'error');
                }

            } catch (error) {
                log(`‚ùå Sending error: ${error.message}`, 'error');
            } finally {
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('sendBtn').textContent = 'üì§ Send Instant Message';
            }
        }

        // Auto-start demo when page loads
        window.onload = function() {
            log('üéØ Welcome to the live demo', 'success');
            log('üì± Click "Connect WhatsApp Instantly" to start', 'info');
        };
    </script>
</body>
</html>